@model IEnumerable<Core.DTOs.Reviews.ReviewResponseDto>
@{
    ViewData["Title"] = "Manage Reviews";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var primaryColor = "#912356";
}

<div class="container-fluid px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4">
        <h1 class="h3 h2-md mt-3 mt-md-4">Manage Reviews</h1>
    </div>

    <!-- Status Filter -->
    <div class="card mb-4">
        <div class="card-header" style="background-color: #f8f9fa;">
            <div class="row align-items-center">
                <div class="col-12">
                    <!-- Mobile: Scrollable buttons -->
                    <div class="filter-buttons-wrapper">
                        <div class="btn-group btn-group-sm d-flex d-md-inline-flex flex-nowrap" role="group">
                            <a href="@Url.Action("Index", "Reviews", new { area = "Admin" })"
                               class="btn @(ViewBag.CurrentStatus == null ? "btn-primary" : "btn-outline-primary") flex-fill flex-md-grow-0"
                               style="@(ViewBag.CurrentStatus == null ? $"background-color: {primaryColor}; border-color: {primaryColor};" : "")">
                                <i class="fas fa-list d-md-none"></i>
                                <i class="fas fa-list mr-1 d-none d-md-inline"></i>
                                <span class="d-none d-sm-inline">All</span> (@(ViewBag.TotalCount ?? 0))
                            </a>
                            <a href="@Url.Action("Index", "Reviews", new { area = "Admin", status = "Pending" })"
                               class="btn @(ViewBag.CurrentStatus == "Pending" ? "btn-warning" : "btn-outline-warning") flex-fill flex-md-grow-0">
                                <i class="fas fa-clock d-md-none"></i>
                                <i class="fas fa-clock mr-1 d-none d-md-inline"></i>
                                <span class="d-none d-sm-inline">Pending</span> (@(ViewBag.PendingCount ?? 0))
                            </a>
                            <a href="@Url.Action("Index", "Reviews", new { area = "Admin", status = "Approved" })"
                               class="btn @(ViewBag.CurrentStatus == "Approved" ? "btn-success" : "btn-outline-success") flex-fill flex-md-grow-0">
                                <i class="fas fa-check d-md-none"></i>
                                <i class="fas fa-check mr-1 d-none d-md-inline"></i>
                                <span class="d-none d-sm-inline">Approved</span> (@(ViewBag.ApprovedCount ?? 0))
                            </a>
                            <a href="@Url.Action("Index", "Reviews", new { area = "Admin", status = "Rejected" })"
                               class="btn @(ViewBag.CurrentStatus == "Rejected" ? "btn-danger" : "btn-outline-danger") flex-fill flex-md-grow-0">
                                <i class="fas fa-times d-md-none"></i>
                                <i class="fas fa-times mr-1 d-none d-md-inline"></i>
                                <span class="d-none d-sm-inline">Rejected</span> (@(ViewBag.RejectedCount ?? 0))
                            </a>
                        </div>
                    </div>
                </div>
                @if (ViewBag.CurrentStatus != null)
                {
                    <div class="col-12 mt-2">
                        <span class="badge badge-info p-2">
                            <i class="fas fa-filter mr-1"></i> Filtered: @ViewBag.CurrentStatus
                        </span>
                    </div>
                }
            </div>
        </div>

        <div class="card-body p-2 p-md-3">
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-lg-block">
                <table class="table table-hover" id="reviewsTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Product</th>
                            <th>Guest</th>
                            <th>Rating</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var review in Model.OrderByDescending(r => r.CreatedDate))
                            {
                                <tr data-id="@review.Id">
                                    <td>
                                        <a href="@Url.Action("Details", "Products", new { area = "", id = review.ProductId })"
                                           target="_blank" class="text-decoration-none" title="@review.ProductName">
                                            @TruncateWords(review.ProductName, 3)
                                        </a>
                                    </td>
                                    <td>
                                        <div><strong>@review.GuestName</strong></div>
                                        <small class="text-muted">@review.GuestEmail</small>
                                    </td>
                                    <td>
                                        <!-- FIXED: Using Font Awesome 5 classes -->
                                        <span class="star-rating text-warning" style="white-space: nowrap;">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= review.Rating)
                                                {
                                                    <i class="fas fa-star"></i>
                                                }
                                                else
                                                {
                                                    <i class="far fa-star"></i>
                                                }
                                            }
                                        </span>
                                    </td>
                                    <td title="@review.Title">
                                        @if (string.IsNullOrEmpty(review.Title))
                                        {
                                            <em class="text-muted">No title</em>
                                        }
                                        else
                                        {
                                            @TruncateWords(review.Title, 3)
                                        }
                                    </td>
                                    <td>
                                        <span class="badge badge-@GetStatusBadgeClass(review.Status) p-2">
                                            @review.Status
                                        </span>
                                    </td>
                                    <td>
                                        <small>@review.CreatedDate.ToString("MMM dd, yyyy")</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-info btn-sm"
                                                    data-toggle="modal" data-target="#reviewModal"
                                                    onclick="viewReview(@review.Id)" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            @if (review.Status == "Pending")
                                            {
                                                <button type="button" class="btn btn-success btn-sm"
                                                        onclick="updateStatus(@review.Id, 'Approved')" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-warning btn-sm"
                                                        onclick="updateStatus(@review.Id, 'Rejected')" title="Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                            <button type="button" class="btn btn-danger btn-sm"
                                                    onclick="deleteReview(@review.Id)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                        <h5>No reviews found</h5>
                                        @if (ViewBag.CurrentStatus != null)
                                        {
                                            <p>No reviews with status '@ViewBag.CurrentStatus'</p>
                                            <a href="@Url.Action("Index", "Reviews", new { area = "Admin" })" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-list mr-1"></i> View All Reviews
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class="d-lg-none">
                @if (Model != null && Model.Any())
                {
                    @foreach (var review in Model.OrderByDescending(r => r.CreatedDate))
                    {
                        <div class="card review-card mb-3" data-id="@review.Id" data-status="@review.Status">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <span class="badge badge-@GetStatusBadgeClass(review.Status)">
                                    @review.Status
                                </span>
                                <small class="text-muted">@review.CreatedDate.ToString("MMM dd, yyyy")</small>
                            </div>
                            <div class="card-body py-2">
                                <!-- Product -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">Product:</small>
                                    <a href="@Url.Action("Details", "Products", new { area = "", id = review.ProductId })"
                                       target="_blank" class="text-decoration-none font-weight-bold">
                                        @TruncateWords(review.ProductName, 5)
                                    </a>
                                </div>

                                <!-- Guest Info -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">Guest:</small>
                                    <strong>@review.GuestName</strong>
                                    <br />
                                    <small class="text-muted">@review.GuestEmail</small>
                                </div>

                                <!-- Rating - FIXED -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">Rating:</small>
                                    <span class="star-rating text-warning" style="white-space: nowrap;">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= review.Rating)
                                            {
                                                <i class="fas fa-star"></i>
                                            }
                                            else
                                            {
                                                <i class="far fa-star"></i>
                                            }
                                        }
                                        <span class="text-dark ml-1">(@review.Rating/5)</span>
                                    </span>
                                </div>

                                <!-- Title -->
                                @if (!string.IsNullOrEmpty(review.Title))
                                {
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Title:</small>
                                        <span>@TruncateWords(review.Title, 6)</span>
                                    </div>
                                }
                            </div>
                            <div class="card-footer py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-info btn-sm"
                                            data-toggle="modal" data-target="#reviewModal"
                                            onclick="viewReview(@review.Id)">
                                        <i class="fas fa-eye mr-1"></i> View
                                    </button>
                                    <div class="btn-group btn-group-sm" role="group">
                                        @if (review.Status == "Pending")
                                        {
                                            <button type="button" class="btn btn-success btn-sm"
                                                    onclick="updateStatus(@review.Id, 'Approved')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-warning btn-sm"
                                                    onclick="updateStatus(@review.Id, 'Rejected')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        }
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="deleteReview(@review.Id)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <h5>No reviews found</h5>
                            @if (ViewBag.CurrentStatus != null)
                            {
                                <p>No reviews with status '@ViewBag.CurrentStatus'</p>
                                <a href="@Url.Action("Index", "Reviews", new { area = "Admin" })" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list mr-1"></i> View All Reviews
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Review Details Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header py-2 py-md-3" style="background-color: @primaryColor; color: white;">
                <h5 class="modal-title" id="reviewModalLabel">Review Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="reviewDetails">
                <div class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anti-forgery token for AJAX requests -->
@Html.AntiForgeryToken()

@section Styles {
    <style>
        /* General responsive adjustments */
        .container-fluid {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Filter buttons wrapper for horizontal scroll on mobile */
        .filter-buttons-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

            .filter-buttons-wrapper::-webkit-scrollbar {
                display: none;
            }

            .filter-buttons-wrapper .btn-group {
                min-width: max-content;
            }

            .filter-buttons-wrapper .btn {
                white-space: nowrap;
                font-size: 0.8rem;
                padding: 0.375rem 0.5rem;
            }

        @@media (min-width: 768px) {
            .filter-buttons-wrapper .btn {
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }
        }

        /* FIXED: Star rating styles */
        .star-rating {
            white-space: nowrap !important;
            display: inline-flex !important;
            align-items: center;
            line-height: 1;
            gap: 2px;
        }

            .star-rating i {
                font-size: 0.9rem;
                display: inline-block;
            }

            .star-rating .fas.fa-star {
                color: #ffc107 !important;
            }

            .star-rating .far.fa-star {
                color: #ffc107 !important;
            }

        @@media (min-width: 768px) {
            .star-rating i {
                font-size: 1rem;
            }
        }

        /* Desktop table styles */
        #reviewsTable td:nth-child(4) {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #reviewsTable td:nth-child(1) {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #reviewsTable th,
        #reviewsTable td {
            vertical-align: middle;
            font-size: 0.875rem;
        }

        /* Mobile card styles */
        .review-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.2s ease;
        }

            .review-card:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .review-card[data-status="Pending"] {
                border-left-color: #ffc107;
            }

            .review-card[data-status="Approved"] {
                border-left-color: #28a745;
            }

            .review-card[data-status="Rejected"] {
                border-left-color: #dc3545;
            }

            .review-card .card-header {
                background-color: #f8f9fa;
                border-bottom: 1px solid #eee;
            }

            .review-card .card-body {
                font-size: 0.9rem;
            }

            .review-card .card-footer {
                background-color: #fff;
                border-top: 1px solid #eee;
            }

        /* Toast notification styles */
        .toast-notification {
            position: fixed;
            top: 10px;
            right: 10px;
            left: 10px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        @@media (min-width: 576px) {
            .toast-notification {
                left: auto;
                min-width: 300px;
                max-width: 400px;
            }
        }

        @@keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal responsive adjustments */
        @@media (max-width: 576px) {
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            .modal-body {
                padding: 0.75rem;
            }

            .modal-header {
                padding: 0.75rem;
            }

            .modal-title {
                font-size: 1rem;
            }
        }

        /* Button adjustments for mobile */
        @@media (max-width: 576px) {
            .btn-group-sm > .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }

            .review-card .btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.8rem;
            }
        }

        /* Page title responsive */
        h1.h3 {
            font-size: 1.5rem;
        }

        @@media (min-width: 768px) {
            h1.h3 {
                font-size: 1.75rem;
            }
        }

        /* Loading state for rows/cards */
        .review-card.loading,
        tr.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Improve touch targets on mobile */
        @@media (max-width: 768px) {
            .btn {
                min-height: 38px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Badge adjustments */
        .badge {
            font-size: 0.75rem;
        }

        @@media (min-width: 768px) {
            .badge {
                font-size: 0.8rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        // View review details in modal
        function viewReview(reviewId) {
            $('#reviewDetails').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading...</p></div>');

            $.ajax({
                url: '/admin/reviews/details/' + reviewId,
                type: 'GET',
                success: function(data) {
                    $('#reviewDetails').html(data);
                },
                error: function(xhr, status, error) {
                    $('#reviewDetails').html('<div class="alert alert-danger m-2"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading review details: ' + error + '</div>');
                }
            });
        }

        // Update review status
        function updateStatus(reviewId, status) {
            if (!confirm('Are you sure you want to change this review status to "' + status + '"?')) {
                return;
            }

            var token = $('input[name="__RequestVerificationToken"]').val();

            if (!token) {
                showNotification('error', 'Security token not found. Please refresh the page.');
                return;
            }

            // Show loading state
            var $row = $('tr[data-id="' + reviewId + '"]');
            var $card = $('.review-card[data-id="' + reviewId + '"]');
            var $buttons = $row.find('.btn-group button').add($card.find('button'));

            $buttons.prop('disabled', true);
            $row.addClass('loading');
            $card.addClass('loading');

            $.ajax({
                url: '/admin/reviews/update-status',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({
                    ReviewId: parseInt(reviewId),
                    Status: status
                }),
                headers: {
                    'RequestVerificationToken': token
                },
                success: function(response) {
                    if (response.success) {
                        showNotification('success', response.message);
                        setTimeout(function() {
                            location.reload();
                        }, 800);
                    } else {
                        showNotification('error', 'Error: ' + response.message);
                        resetLoadingState($row, $card, $buttons);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                    showNotification('error', 'An error occurred: ' + (xhr.responseJSON?.message || error));
                    resetLoadingState($row, $card, $buttons);
                }
            });
        }

        // Delete review
        function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?\n\nThis action cannot be undone.')) {
                return;
            }

            var token = $('input[name="__RequestVerificationToken"]').val();

            if (!token) {
                showNotification('error', 'Security token not found. Please refresh the page.');
                return;
            }

            var $row = $('tr[data-id="' + reviewId + '"]');
            var $card = $('.review-card[data-id="' + reviewId + '"]');
            var $buttons = $row.find('.btn-group button').add($card.find('button'));

            $buttons.prop('disabled', true);
            $row.addClass('loading');
            $card.addClass('loading');

            $.ajax({
                url: '/admin/reviews/delete/' + reviewId,
                type: 'POST',
                headers: {
                    'RequestVerificationToken': token,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.success) {
                        showNotification('success', response.message);
                        $row.fadeOut(400, function() { $(this).remove(); });
                        $card.fadeOut(400, function() { $(this).remove(); });
                    } else {
                        showNotification('error', 'Error: ' + response.message);
                        resetLoadingState($row, $card, $buttons);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                    showNotification('error', 'An error occurred: ' + error);
                    resetLoadingState($row, $card, $buttons);
                }
            });
        }

        // Reset loading state helper
        function resetLoadingState($row, $card, $buttons) {
            $buttons.prop('disabled', false);
            $row.removeClass('loading');
            $card.removeClass('loading');
        }

        // Toast notification function
        function showNotification(type, message) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            // Remove any existing notifications
            $('.toast-notification').remove();

            var $alert = $('<div class="alert ' + alertClass + ' alert-dismissible fade show toast-notification">' +
                '<i class="fas ' + icon + ' mr-2"></i>' + message +
                '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                '</div>');

            $('body').append($alert);

            setTimeout(function() {
                $alert.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }

        // Handle modal update status (called from _ReviewDetails partial)
        function updateStatusFromModal(reviewId, status) {
            $('#reviewModal').modal('hide');
            updateStatus(reviewId, status);
        }
    </script>
}

@functions {
    public string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Approved" => "success",
            "Rejected" => "danger",
            _ => "secondary"
        };
    }

    public string TruncateWords(string text, int maxWords)
    {
        if (string.IsNullOrEmpty(text))
            return string.Empty;

        var words = text.Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);

        if (words.Length <= maxWords)
            return text;

        return string.Join(" ", words.Take(maxWords)) + "...";
    }
}