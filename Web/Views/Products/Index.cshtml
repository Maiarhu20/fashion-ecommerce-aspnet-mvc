@model IEnumerable<Core.DTOs.Products.ProductListDto>
@{
    ViewData["Title"] = ViewBag.Title ?? "Products";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var primaryColor = "#912356";
    var allProducts = Model?.ToList() ?? new List<Core.DTOs.Products.ProductListDto>();
    var pageSize = 10;
}

@Html.AntiForgeryToken()

<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" asp-controller="Home" asp-action="Index">Home</a>
                @if (ViewBag.ViewType == "category" && ViewBag.Category != null)
                {
                    <a class="breadcrumb-item text-dark" asp-action="AllProducts">Products</a>
                    <span class="breadcrumb-item active">@ViewBag.Category.Name</span>
                }
                else
                {
                    <span class="breadcrumb-item active">All Products</span>
                }
            </nav>
        </div>
    </div>
</div>

<!-- Products Start -->
<div class="container-fluid pt-5 pb-5">
    <div class="row px-xl-5">
        <!-- Section Title -->
        <div class="col-12 mb-5">
            <div class="text-center">
                <h2 class="section-title px-5">
                    <span class="px-2">@(ViewBag.ViewType == "category" ? ViewBag.Category.Name : "All Products")</span>
                </h2>
                <p class="lead mt-3">@(ViewBag.Category?.Description ?? "Browse our complete collection")</p>
            </div>
        </div>

        @if (allProducts.Any())
        {
            <div class="col-12">
                <div class="row" id="products-container">
                    @for (int i = 0; i < allProducts.Count; i++)
                    {
                        var product = allProducts[i];
                        var isHidden = i >= pageSize ? "d-none" : "";
                        <div class="col-lg-3 col-md-4 col-6 mb-4 product-card-wrapper @isHidden" data-index="@i">
                            <div class="card product-item border-0 mb-4 h-100 product-card-clickable"
                                 data-product-url="@Url.Action("Details", "Products", new { id = product.Id })">

                                <!-- Updated Image Header to match New Arrivals Style -->
                                <div class="card-header bg-transparent border-0 p-0">
                                    <div id="productCarousel-@product.Id" class="carousel slide product-image-carousel" data-interval="3500">
                                        <div class="carousel-inner product-image-frame">
                                            @if (product.Images != null && product.Images.Any())
                                            {
                                                @for (int j = 0; j < product.Images.Count; j++)
                                                {
                                                    <div class="carousel-item @(j == 0 ? "active" : "")">
                                                        <img class="product-image"
                                                             src="@product.Images[j].ImageUrl"
                                                             alt="@product.Name">
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="carousel-item active">
                                                    <img class="product-image"
                                                         src="@(product.PrimaryImageUrl ?? "/images/default-product.jpg")"
                                                         alt="@product.Name">
                                                </div>
                                            }
                                        </div>

                                        @if (product.DiscountPercent > 0)
                                        {
                                            <div class="position-absolute" style="top: 10px; left: 10px; z-index: 10;">
                                                <span class="badge py-1 px-2" style="background-color: #fff3cd; color: #856404; font-size: 0.8rem;">
                                                    -@product.DiscountPercent%
                                                </span>
                                            </div>
                                        }

                                        @if (product.Images != null && product.Images.Count > 1)
                                        {
                                            <a class="carousel-control-prev d-none d-md-flex" href="#productCarousel-@product.Id" role="button" data-slide="prev">
                                                <div class="btn btn-square btn-primary-color"><i class="fa fa-angle-left"></i></div>
                                            </a>
                                            <a class="carousel-control-next d-none d-md-flex" href="#productCarousel-@product.Id" role="button" data-slide="next">
                                                <div class="btn btn-square btn-primary-color"><i class="fa fa-angle-right"></i></div>
                                            </a>
                                        }
                                    </div>
                                </div>

                                <div class="card-body border-left border-right text-center p-0 pt-4 pb-3">
                                    <h6 class="text-truncate mb-2 px-2">@product.Name</h6>
                                    <div class="d-flex justify-content-center mb-2">
                                        @if (product.DiscountPercent > 0)
                                        {
                                            <h6 class="text-primary-color font-weight-bold">EGP @product.FinalPrice.ToString("F2")</h6>
                                            <h6 class="text-muted ml-2"><del>EGP @product.Price.ToString("F2")</del></h6>
                                        }
                                        else
                                        {
                                            <h6 class="text-primary-color font-weight-bold">EGP @product.Price.ToString("F2")</h6>
                                        }
                                    </div>

                                    @if (product.Colors != null && product.Colors.Any())
                                    {
                                        @* <div class="d-flex justify-content-center mb-2">
                                            @foreach (var color in product.Colors.Take(3))
                                            {
                                                <div class="mr-1 color-dot" style="background-color: @color.ColorHexCode;" title="@color.ColorName"></div>
                                            }
                                        </div>
                                        <small class="text-muted mb-1 d-block product-color-hint">(Select color in details)</small> *@
                                        <div class="d-flex justify-content-center mb-2 product-colors">
                                            @foreach (var color in product.Colors.Take(3))
                                            {
                                                <div class="mr-1 color-dot"
                                                     style="width: 15px; height: 15px; background-color: @color.ColorHexCode; border-radius: 50%; border: 1px solid #ccc;"
                                                     title="@color.ColorName">
                                                </div>
                                            }
                                            @if (product.Colors.Count > 3)
                                            {
                                                <small class="text-muted">+@(product.Colors.Count - 3) more</small>
                                            }
                                        </div>
                                        <small class="text-muted mb-1 d-block product-color-hint">(Select color in details)</small>
                                    }

                                    <div class="d-flex justify-content-center">
                                        <small>
                                            <i class="fas fa-shopping-bag text-primary-color mr-1"></i>
                                            @if (product.StockQuantity > 0)
                                            {
                                                <span class="@(product.StockQuantity <= 20 ? "text-warning" : "")">@(product.StockQuantity > 20 ? "In Stock" : product.StockQuantity + " left")</span>
                                            }
                                            else
                                            {

                                                <span class="text-danger">Out of Stock</span>
                                            }
                                        </small>
                                    </div>
                                </div>

                                <!-- Footer -->
                                <div class="card-footer d-flex justify-content-between bg-light border">
                                    <a asp-action="Details" asp-route-id="@product.Id" class="btn btn-sm text-dark p-0 d-none d-md-inline">
                                        <i class="fas fa-eye text-primary-color"></i> Details
                                    </a>

                                    @if (product.StockQuantity > 0)
                                    {
                                        <a href="#" class="btn btn-sm text-dark p-0 add-to-cart-btn mx-auto mx-md-0"
                                           data-product-id="@product.Id"
                                           data-product-name="@product.Name"
                                           data-color="@(product.Colors?.FirstOrDefault()?.ColorName)">
                                            <i class="fas fa-shopping-cart text-primary-color mr-1"></i>Add To Cart
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (allProducts.Count > pageSize)
                {
                    <div class="col-12 text-center mt-4" id="load-more-container">
                        <button type="button" class="btn btn-primary-bg btn-lg px-5 py-3 rounded-pill" id="load-more-btn">
                            Load More Products <span class="badge badge-light ml-2" id="remaining-count">@(allProducts.Count - pageSize)</span>
                        </button>
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    :root {
        --primary-color: #912356;
        --primary-light: #f8eef2;
    }

    .text-primary-color {
        color: var(--primary-color) !important;
    }

    .btn-primary-bg {
        background-color: var(--primary-color) !important;
        color: white !important;
    }

    /* Apply New Arrival Aspect Ratio (4:5) */
    .product-image-frame {
        aspect-ratio: 4 / 5;
        width: 100%;
        background: var(--primary-light);
        position: relative;
        overflow: hidden;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        display: block;
    }

    /* Desktop switches to Cover for a cleaner catalog look, similar to Home */
    @@media (min-width: 768px) {
        .product-image {
            object-fit: cover;
        }
    }

    .product-item {
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef !important;
    }

        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(145, 35, 86, 0.15) !important;
            border-color: var(--primary-color) !important;
        }

    .btn-square {
        width: 30px;
        height: 30px;
        background-color: var(--primary-color);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .color-dot {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 1px solid #ddd;
    }

    /* Toast Animation */
    .toast-alert {
        animation: slideInRight 0.3s ease;
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
        }

        to {
            transform: translateX(0);
        }
    }

    @@media (max-width: 767.98px) {
        .col-6 {
            padding: 0 6px;
        }

        .product-item .card-body h6 {
            font-size: 0.85rem;
        }
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load More Logic
            $('#load-more-btn').on('click', function() {
                let pageSize = @pageSize;
                let container = $('#products-container');
                let hidden = container.find('.product-card-wrapper.d-none').slice(0, pageSize);

                hidden.removeClass('d-none').hide().fadeIn(400);

                let remaining = container.find('.product-card-wrapper.d-none').length;
                $('#remaining-count').text(remaining);
                if (remaining === 0) $('#load-more-container').fadeOut();
            });

            // Initialize Carousels
            $('.product-image-carousel').carousel({ interval: 3500 });

            // Card click for mobile
            $('.product-card-clickable').on('click', function(e) {
                if ($(window).width() < 768 && !$(e.target).closest('.add-to-cart-btn, .carousel-control').length) {
                    window.location.href = $(this).data('product-url');
                }
            });

            // Add to Cart AJAX
            $('.add-to-cart-btn').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                let btn = $(this);
                let originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                $.ajax({
                    url: '/cart/add-to-cart',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                    data: { ProductId: btn.data('product-id'), Quantity: 1, SelectedColor: btn.data('color') },
                    success: function(res) {
                        if (res.success) {
                            showToast(btn.data('product-name') + ' added!', 'success');
                            if (typeof updateCartBadge === 'function') updateCartBadge();
                        } else {
                            showToast(res.message, 'error');
                        }
                    },
                    complete: function() { btn.prop('disabled', false).html(originalHtml); }
                });
            });

            function showToast(msg, type) {
                let cls = type === 'success' ? 'alert-success' : 'alert-danger';
                let toast = $(`<div class="toast-alert alert ${cls} alert-dismissible fade show">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>${msg}</strong></div>`);
                $('body').append(toast);
                setTimeout(() => toast.alert('close'), 3000);
            }
        });
    </script>
}